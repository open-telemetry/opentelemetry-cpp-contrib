# spdlog OpenTelemetry sink

## Features

- Supports spdlog sink mechanism both, single- and multi-threaded
- Supports OpenTelemetry SDK without any changes

## Requirements

- Current release tested only with Ubuntu 20.04.6 LTS
- OpenTelemetry >= v1.12.0 
- spdlog >= v1.11.0

### Usage

Please see below for [manual build](#build). Otherwise please use one of the [released versions](https://github.com/open-telemetry/opentelemetry-cpp-contrib/releases).

### Configuration

The OpenTelemetry sink can be configured in much the same way as any other spdlog sink.

A common scenario is by creating a logger with the `OpenTelemetrySink` template in its sinks list, either by specifying the single-threaded `opentelemetry_sink_st` or the multi-threaded `opentelemetry_sink_mt` concrete classes, with the following lines of code:

```cpp
#include <opentelemetry/instrumentation/spdlog/sink.h>

auto otel_sink = std::make_shared<spdlog::sinks::opentelemetry_sink_mt>();
otel_sink->set_level(spdlog::level::info);
auto logger = spdlog::logger("OTelLogger", otel_sink);
```

For more details, refer to the [examples](#examples) section.

## Development

### Requirements

- C++11
- CMake 3.x
- [OpenTelemetry-cpp](https://github.com/open-telemetry/opentelemetry-cpp)
- [spdlog](https://github.com/gabime/spdlog)
- vcpkg **_(optional)_**

### Build
As a preparation step, both depedencies need to be built and available in the development environment. This can be a manual build, by following the instructions for the corresponding package, or one could opt to use a package management system such as _vcpkg_ or _conan_.

Assuming the packages are available on the system, configure CMake as usual:

```bash
mkdir build
cd build
cmake [path/to/opentelemetry-cpp-contrib]/instrumentation/spdlog -DBUILD_SHARED_LIBS=ON
make
```

Optionally, if the packages were provided via vcpkg, pass in to the _cmake_ command above the flag `-DCMAKE_TOOLCHAIN_FILE=${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake` where VCPKG_ROOT is where vcpkg was installed. 

Now, simply link the target source (i.e., main.cc in the example below) against _spdlog_, possibly also its dependency lib _fmt_, as well as _opentelemetry_spdlog_:

```bash
g++ main.cc -lspdlog -lopentelemetry_spdlog -o main
```

### Installation ###

When configuring the build, if the flag `-DOPENTELEMETRY_INSTALL=ON` is passed, CMake will ensure to set up the install scripts. Once the build succeeds, running `make install` will make the sink header(s) and library available under the usr include and lib directories, respectively.

### Testing

A small suite of unit tests is available under the `test` directory. It can be enabled by passing `-DBUILD_TESTING=ON` when configuring CMake, which will generate an executable called **sink_test**.

### Examples

An example executable is available to test the functionality of the sink. For ease of setup, it uses the _OStreamLogRecordExporter_ to display the contents of the intercepted spdlog message as an OTel _LogRecord_. It can be generated by adding `-DWITH_EXAMPLES=ON` when configuring CMake, which will ultimately produce the **otel_sink_example** executable.

Running  `./otel_sink_example` would produce an output similar to below:

```
[2023-12-27 00:46:09.111] [OTelLogger] [debug] This message will be ignored
[2023-12-27 00:46:09.111] [OTelLogger] [info] This message will be processed
{
  timestamp          : 1703637969111736310
  observed_timestamp : 1703637969111813143
  severity_num       : 9
  severity_text      : INFO
  body               : This message will be processed
  resource           :
    service.name: unknown_service
    telemetry.sdk.version: 1.12.0
    telemetry.sdk.name: opentelemetry
    telemetry.sdk.language: cpp
  attributes         :
    thread.id: 15644
  event_id           : 0
  event_name         :
  trace_id           : d2695462067d7aab7e0ed163d27d54f8
  span_id            : 4c2389a6f920572d
  trace_flags        : 01
  scope              :
    name             : spdlog
    version          : 1.12.0
    schema_url       :
    attributes       :
}
```

The above excerpt shows that the log line containing "**[debug] This message will be ignored**" was not set up to use the OpenTelemetry sink and, thus, did not make it into the log exporter. 

Similarly, the DEBUG log message "**[info] This message will be processed**" was invoked from a logger that was set up to use the Opentelemetry sink and it was successfully processed by the SDK. 

This example will also output a span with the same ID as the log record, to showcase how the two signals can be correlated via trace and/or span ID.
