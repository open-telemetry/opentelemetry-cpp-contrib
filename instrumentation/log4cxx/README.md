# Log4cxx (Apache) OpenTelemetry appender

## Features

- Supports log4cxx appender programatically or via config file
- Supports OpenTelemetry SDK without any changes

## Requirements

- Current release tested only with Ubuntu 20.04.6 LTS
- OpenTelemetry >= v1.12.0 
- log4cxx (Apache) >= v1.0.0

### Usage

Please see below for [manual build](#build). Otherwise please use one of the [released versions](https://github.com/open-telemetry/opentelemetry-cpp-contrib/releases).

### Configuration

The OpenTelemetry appender can be configured in much the same way as any other log4cxx appender.

A common scenario is by attaching the `OpenTelemetryAppender` to a logger via a XML config file:

```xml
<appender name="OTelAppender" class="OpenTelemetryAppender" />

<logger name="SomeLogger" additivity="false">
   <appender-ref ref="OTelAppender"/>
</logger>
```

The same effect can be achieved programatically with a few lines of code:

```cpp
#include <opentelemetry/instrumentation/log4cxx/appender.h>

auto some_logger = log4cxx::Logger::getLogger("SomeLogger");
some_logger->addAppender(std::make_shared<log4cxx::OpenTelemetryAppender>());
some_logger->setAdditivity(false);
```

For more details, refer to the [examples](#examples) section.

## Development

### Requirements

- C++11
- CMake 3.x
- [OpenTelemetry-cpp](https://github.com/open-telemetry/opentelemetry-cpp)
- [Log4cxx](https://github.com/apache/logging-log4cxx)
- vcpkg **_(optional)_**

### Build
As a preparation step, both depedencies need to be built and available in the development environment. This can be a manual build, by following the instructions for the corresponding package, or one could opt to use a package management system such as _vcpkg_ or _conan_.

Assuming the packages are available on the system, configure CMake as usual:

```bash
mkdir build
cd build
cmake [path/to/opentelemetry-cpp-contrib]/instrumentation/log4cxx -DBUILD_SHARED_LIBS=ON
make
```

Optionally, if the packages were provided via vcpkg, pass in to the _cmake_ command above the flag `-DCMAKE_TOOLCHAIN_FILE=${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake` where VCPKG_ROOT is where vcpkg was installed. 

Now, simply link the target source (i.e., main.cc in the example below) against _log4cxx_ and _opentelemetry_log4cxx_:

```bash
g++ main.cc -llog4cxx -lopentelemetry_log4cxx -o main
```

### Installation ###

When configuring the build, if the flag `-DOPENTELEMETRY_INSTALL=ON` is passed, CMake will ensure to set up the install scripts. Once the build succeeds, running `make install` will make the appender header(s) and library available under the usr include and lib directories, respectively.

### Testing

A small suite of unit tests is available under the `test` directory. It can be enabled by passing `-DBUILD_TESTING=ON` when configuring CMake, which will generate an executable called **appender_test**.

### Examples

An example executable is available to test the functionality of the appender. For ease of setup, it uses the _OStreamLogRecordExporter_ to display the contents of the intercepted log4cxx event as an OTel _LogRecord_. It can be generated by adding `-DWITH_EXAMPLES=ON` when configuring CMake, which will ultimately produce the **otel_appender_example** executable.

By default, this executable configures the appender and logger programatically.
However, it will also accept a XML config file which provides a more flexible approach. An example configuration is available under `example/otel-appender.xml` and can be fed to the program as follows:

```cpp
./otel_appender_example [path_to_file/]otel-appender.xml
```

Both scenarios, whether that be programatically or via configuration file, would produce an output similar to below:

```
>>> Setting up appender from /otel-contrib/instrumentation/log4cxx/example/otel-appender.xml
[2023-12-26 07:09:39] root INFO  - This message will be ignored
{
  timestamp          : 1703574579523570000
  observed_timestamp : 1703574579523660840
  severity_num       : 5
  severity_text      : DEBUG
  body               : This message will be processed
  resource           :
    service.name: unknown_service
    telemetry.sdk.version: 1.12.0
    telemetry.sdk.name: opentelemetry
    telemetry.sdk.language: cpp
  attributes         :
    thread.name: 0x7fae5f373bc0
  event_id           : 0
  event_name         :
  trace_id           : dc62ae8020403633fcce3d50eeb34b3c
  span_id            : 7eaa73e3d06d78d0
  trace_flags        : 01
  scope              :
    name             : log4cxx
    version          : 1.0.0
    schema_url       :
    attributes       :
}
```

The above excerpt shows that the log line containing "**root INFO  - This message will be ignored**" was not set up to use the OpenTelemetry appender and, thus, did not make it into the log exporter. 

Similarly, the DEBUG log message "**This message will be processed**" was invoked from a logger that was set up to use the Opentelemetry appender and it was successfully processed by the SDK. 

This example will also output a span with the same ID as the log record, to showcase how the two signals can be correlated via trace and/or span ID.
